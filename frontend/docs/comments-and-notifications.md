# مراجعة التعليقات والإشعارات

## قبل/بعد (إزالة التكرار وتوحيد العرض)
- **قبل:** لم يكن هناك ضبط لصلاحيات عرض حالة التسليم/المشاهدة، ما سمح بعرض ✅/✅✅ لأي مشاهد يملك بيانات التعليق مؤقتًا.
- **بعد:** تم تقييد عرض حالة التسليم/المشاهدة على كاتب التعليق أو المستلم فقط، مع الحفاظ على EntityComments كمكوّن موحد في كل صفحات التفاصيل.

## معايير مفاتيح React Query
- **commentsKey**: `[entityType, entityId, 'comments']` كما يتم توليدها عبر `buildCommentsQueryKey` داخل `useRealtimeComments` وتُستخدم في الجلب، الإضافة، التحديث الفوري، ووضع علامات القراءة.
- **detailKey**: `[root, entityId]` حيث `root` هو اسم الكيان كما في `DETAIL_KEY_ROOTS` (`contract`, `legalAdvice`, `investigation`, `litigation`).

## حالات واجهة المستخدم
- عرض التعليقات فور فتح التفاصيل مع `placeholderData(prev => prev)` لضمان عدم مسح القائمة أثناء إعادة الجلب.
- حالة فارغة تظهر فقط عندما تكون `!isLoading && !isFetching && !isError`.
- التحديث المتفائل يحافظ على العناصر السابقة ويستبدل الـ id المؤقت فقط عند نجاح الإرسال.

## التحديث الفوري (Realtime)
- الاشتراك في قناة `entity.{entityType}.{entityId}` عبر `useRealtimeComments`.
- أحداث `.CommentCreated` تدمج التعليق الجديد وتحدّث عدادات الكيان بدون `invalidate`.
- أحداث `.CommentReceiptDelivered` و `.CommentReceiptRead` تحدّث إيصالات التعليق فقط عبر `setQueryData` مع احترام الصلاحيات في العرض داخل الواجهة.

## تحقق يدوي مختصر
1. فتح تفاصيل كيان فيه تعليقات موجودة → تظهر فورًا بدون فليكَر.
2. فتح نفس الكيان في نافذتين → إضافة تعليق من النافذة الأولى يظهر مباشرة في الثانية.
3. كاتب التعليق يرى ✅ فور الإرسال والمستلم يحوّلها إلى ✅✅ لحظيًا بعد القراءة.
4. مستخدم بلا صلاحية تعليق يرى رسالة الرفض ولا تصله إيصالات أو حالات قراءة.
