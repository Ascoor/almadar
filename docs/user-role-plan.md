# مخطط متكامل لإدارة المستخدمين حسب الدرجات الوظيفية

يوضح هذا المستند تصورًا متكاملاً لدمج المستخدمين (موظف، محامٍ، رؤساء أقسام) داخل النظام وربطهم بالأقسام والإجراءات مع ضبط الصلاحيات في الواجهة والخلفية.

## نظرة عامة على الوضع الحالي
- يعتمد الـ **Backend** على Laravel مع حزمة **spatie/laravel-permission** للتعامل مع الأدوار والصلاحيات، مع وجود نموذج `User` (انظر `app/Models/User.php`) مفعل لخاصية `HasRoles` ومعرّف لتحميل الأدوار والصلاحيات مسبقًا.
- توجد نماذج لمجالات العمل (مثل القضايا، العقود، التحقيقات) يمكن ربطها بالمستخدمين لتسجيل المسؤوليات.
- الواجهة الأمامية مبنية بـ React/Vite مع تنظيم الصفحات في مجلد `src/pages` وخدمات الاتصال في `src/services`.

## هيكل البيانات المقترح
1. **الكيانات الأساسية**
   - **Department**: تخزين الأقسام (إداري، قانوني، تحقيقات... إلخ) مع حقول الاسم، الوصف، رئيس القسم (علاقة مع `User`).
   - **JobGrade**: درجات وظيفية (موظف، محامٍ، رئيس قسم، مدير نظام) لتسهيل ضبط الصلاحيات وتسميات الواجهة.
   - **StaffProfile**: ملف وظيفي مرتبط بالمستخدم يشير إلى القسم، الدرجة، التخصص القانوني، وتاريخ التعيين.

2. **الربط مع الإجراءات**
   - إضافة علاقات (مثل `assigned_user_id`, `assigned_department_id`) داخل نماذج الإجراءات القائمة (`Contract`, `Litigation`, `Investigation`, `LegalAdvice`) لتحديد المسؤول عن التعاقد/الإجراء.
   - دعم تعدد المسؤوليات عبر جداول وسيطة عند الحاجة (مثل محقق/مشرف/معد تقارير) باستخدام pivot يحتوي على الدور الوظيفي في الإجراء.

3. **الصلاحيات والأدوار**
   - أمثلة صلاحيات: `contracts.create`, `contracts.review`, `investigations.assign`, `litigations.approve`, `departments.manage`, `roles.manage`.
   - خرائط أدوار افتراضية:
     - **موظف**: إنشاء/تحديث المهام الموكلة له فقط.
     - **محامٍ**: إضافة مذكرات قانونية وربطها بالملفات مع إمكانية التوقيع إن وجد.
     - **رئيس قسم**: توزيع المهام على التابعين، مراجعة واعتماد الإجراءات داخل القسم.
     - **مدير نظام**: إدارة الصلاحيات والأقسام والمستخدمين.

## تغييرات قاعدة البيانات (Migration)
1. إنشاء جداول `departments`, `job_grades`, `staff_profiles`.
2. تعديل جداول الإجراءات الحالية لإضافة مفاتيح المسؤولية (`assigned_user_id`, `assigned_department_id`) ومفاتيح pivot للأدوار المتعددة إن لزم.
3. تهيئة Seeder يضيف الأقسام والدرجات الافتراضية والأدوار مع صلاحياتها، مع إنشاء حسابات نموذجية للاختبار.

## واجهات برمجية (API)
- **المستخدمون/الملفات الوظيفية**
  - `GET /api/staff`: إرجاع المستخدمين مع القسم والدرجة والأدوار.
  - `POST /api/staff`: إنشاء مستخدم مع ملف وظيفي وتعيين القسم والدرجة والصلاحيات.
  - `PUT /api/staff/{id}`: تحديث البيانات وربط الأدوار/الصلاحيات.
- **الأقسام**
  - CRUD للأقسام مع دعم تعيين رئيس قسم وربط المستخدمين بالقسم.
- **التكليف والإجراءات**
  - نقاط نهاية لإسناد المستخدمين للإجراءات (`/contracts/{id}/assign`, `/investigations/{id}/assign`... إلخ) مع تسجيل تاريخ التعيين والدور داخل الإجراء.
- **الصلاحيات**
  - نقطة إدارة عامة لإضافة صلاحيات خاصة بالمحرر أو أي دور مخصص، مع حماية Endpoints بواسطة Middleware `can`/`role`.

## منطق العمل في الـ Backend
- استخدام Events/Listeners لتسجيل تاريخ الإسناد وتغيير المسؤوليات.
- إضافة Policies لكل نموذج (Contract, Litigation, Investigation...) لضبط التفويض بناءً على الدور/القسم.
- دعم **soft deletes** أو أرشفة التعديلات لتتبع تغييرات المسؤوليات.

## الواجهة الأمامية (React)
1. **إدارة المستخدمين**
   - صفحة قائمة الموظفين تعرض القسم، الدرجة، الأدوار، حالة التفعيل.
   - نماذج إنشاء/تعديل مستخدم مع اختيار القسم والدرجة والصلاحيات الموروثة/الخاصة.
2. **الأقسام والهيكل التنظيمي**
   - صفحة لإدارة الأقسام وتعيين رئيس القسم، مع شجرة تُظهر التابعين.
3. **الإسناد داخل الإجراءات**
   - في صفحات العقود/القضايا/التحقيقات، إضافة مكوّن لاختيار المسؤول أو الفريق مع إظهار الدور داخل الإجراء.
   - شارات أو ألوان تبين الدور (رئيس قسم، محقق، محامٍ) داخل تفاصيل الإجراء.
4. **حماية الواجهة**
   - حارس Route يعتمد على صلاحيات المستخدم (من التوكن) لضبط الوصول.
   - إخفاء/تعطيل الأزرار بناءً على `permissions` المسترجعة من الـ API.

## خطة الدمج والتنفيذ المرحلية (خطوات قابلة للتنفيذ فورًا)
> اتبع المراحل بالترتيب. كل خطوة تشير إلى الملفات/الأوامر الدقيقة لضمان إمكانية التشغيل الفوري.

1) **المرحلة الأولى: النمذجة والتهيئة (Backend/Laravel)**
   1. [ ] إنشاء الجداول: شغّل `php artisan make:migration create_departments_job_grades_staff_profiles_tables` وأضف الأعمدة (الاسم، الوصف، `head_user_id`، المراجع الخارجية) ثم نفّذ `php artisan migrate`.
   2. [ ] ربط المستخدمين: في `app/Models/User.php` أضف علاقة `hasOne` مع `StaffProfile` وعلاقات `belongsTo` لكل من `department` و`jobGrade`.
   3. [ ] Seeder جاهز: أنشئ `database/seeders/DepartmentJobGradeSeeder.php` لتعبئة الأقسام والدرجات والأدوار الافتراضية، ثم حدّث `DatabaseSeeder` لاستدعائه.
   4. [ ] تعريف الصلاحيات مركزيًا: أضف ملف `config/permissions.php` يحوي أسماء الأدوار والصلاحيات (مثل `contracts.create`, `investigations.assign`) مع مصفوفة ربط الدور بالتصريح.
   5. [ ] مزامنة الأدوار والصلاحيات: نفّذ `php artisan permission:create-role --name=...` و`php artisan permission:create-permission --name=...` داخل Seeder أو أمر Artisan مخصص لضمان التهيئة الآلية.

2) **المرحلة الثانية: واجهات الـAPI والحوكمة (Backend/Laravel)**
   1. [ ] CRUD الأقسام: أنشئ `app/Http/Controllers/DepartmentController.php` + Requests + Routes (`routes/api.php`) مع نقطة لتعيين رئيس قسم (`/departments/{id}/assign-head`).
   2. [ ] CRUD الموظفين/الملفات الوظيفية: أنشئ `StaffController` يدير إنشاء المستخدم، ربط `StaffProfile`, تعيين الأدوار والصلاحيات؛ أضف فحوصات صلاحية عبر `authorize` أو `Policy`.
   3. [ ] نقاط إسناد الإجراءات: أضف مسارات مثل `/contracts/{id}/assign` و `/investigations/{id}/assign` مع Controller action يسجل `assigned_user_id`, `assigned_department_id` ودور المستخدم داخل الـ pivot.
   4. [ ] سياسات الوصول: أنشئ `ContractPolicy`, `LitigationPolicy`, `InvestigationPolicy`, `LegalAdvicePolicy`، وفعّلها في `AuthServiceProvider`; اربط المسارات بـ `middleware('can:action,model')` أو `role`.
   5. [ ] سجل تغييرات المسؤوليات: أضف Event `ResponsibilityChanged` و Listener يسجّل في جدول `responsibility_audits`; فعّل التسجيل داخل نقاط الإسناد السابقة.

3) **المرحلة الثالثة: الواجهة الأمامية (React/Vite)**
   1. [ ] قائمة الموظفين: أنشئ صفحة `src/pages/Staff/List.tsx` تستخدم خدمة `src/services/staff.ts` لجلب الموظفين مع البحث/الفرز حسب القسم والدرجة والحالة.
   2. [ ] نماذج الإنشاء/التعديل: في `src/pages/Staff/Form.tsx` أضف حقول القسم، الدرجة، الأدوار، والصلاحيات الخاصة؛ استعمل `react-hook-form` (إن وُجد) مع تحقق فوري من صلاحيات المستخدم الحالي.
   3. [ ] إدارة الأقسام: أضف صفحة `src/pages/Departments/index.tsx` لCRUD الأقسام وتعيين رئيس القسم مع عرض شجرة التابعين (استعمل مكون Tree إن متاح أو قائمة متداخلة).
   4. [ ] مكوّن الإسناد داخل الإجراءات: أدرج مكوّنًا مشتركًا `src/components/Assignment/AssigneePicker.tsx` يُستخدم في صفحات العقود/القضايا/التحقيقات ويُظهر الدور بلون (Badge) مع تخزين الدور داخل الطلب.
   5. [ ] حراسة الواجهة: فعّل حارس Routes يعتمد على صلاحيات المستخدم من الـ token (مثلاً `useAuthGuard` داخل `src/router.tsx`) مع إخفاء/تعطيل الأزرار وفق `permissions` القادمة من الـ API.

4) **المرحلة الرابعة: الجودة والتدقيق (Backend + Frontend)**
   1. [ ] اختبارات سياسات الوصول: أضف اختبارات وحدات في `tests/Feature/Policies/...` للتأكد من قواعد `view/create/assign` حسب الدور والقسم.
   2. [ ] اختبارات تدفق الإسناد: اكتب سيناريو متكامل يغطي إنشاء عقد، إسناد محامٍ/رئيس قسم، تسجيل Event، والتحقق من السجل في `responsibility_audits`.
   3. [ ] بيانات وسيناريوهات UAT: حدّث `DatabaseSeeder` لإضافة عينات (موظف، محامٍ، رئيس قسم، مدير نظام) مع ملفات وظيفية مرتبطة؛ وثّق خطوات UAT في `docs/UAT-user-roles.md`.
   4. [ ] دليل الاستخدام والتدريب: أضف إرشادات مختصرة في `docs/user-guide.md` حول كيفية الإسناد والتوقيع، مع ملاحظات الترجمة الثنائية.

## اعتبارات إضافية (تحقق قبل الإطلاق)
- [ ] تفعيل الترجمة المزدوجة للعربية/الإنجليزية في الواجهة والأدوار (ملفات `lang` وواجهة React).
- [ ] تمكين سجل النشاط (Audit Trail) لتغيير المسؤوليات داخل الإجراءات (تحقق من إدراج الـ Listener وكتابته في الجدول).
- [ ] دعم أدوار مخصصة لكل قسم (مثل "محقق أول") مع صلاحيات مركبة عبر `spatie/laravel-permission`.
- [ ] إضافة تقارير لتوزيع المهام حسب الأقسام والأدوار لمراقبة الحمل التشغيلي (صفحة `Reports` أو استعلامات جاهزة).
