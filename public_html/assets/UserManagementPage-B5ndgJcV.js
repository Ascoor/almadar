import{r as l,j as e,h as V,P as H,M as G,T as _,i as W,k as q,l as X}from"./pdf-D5yLTPdL.js";import{S as Y,t as y,c as F,q as J,T as K,U as Q,V as Z,m as D,B as E,C as ee,W as se,d as te,X as ae,Y as re}from"./index-BrCJu-Nk.js";import ne from"./SectionHeader-DYN9xJld.js";import{T as ie}from"./TableComponent-oB2Hgwhz.js";import le from"./GlobalConfirmDeleteModal-POJBepxz.js";import"./react-UnWXGYuj.js";import"./vendor-CTvvdsW_.js";const oe="/assets/users-icon-D4in6ISP.png",de={admin:"أدمن",staff:"موظف",user:"مستخدم"},ce=s=>de[s]||s;function me({isOpen:s,onClose:d,selectedUser:t,refreshUsers:n,createUser:o,updateUser:x}){const f=!!t,[i,P]=l.useState({name:"",role:"",emailPrefix:"",image:null}),[h,L]=l.useState(null),[v,N]=l.useState({}),[u,b]=l.useState(!1),[k,C]=l.useState([]);l.useEffect(()=>{s&&(S(),c())},[s,t]);const S=async()=>{try{const r=await Y(),p=Array.isArray(r)?r:r.roles||[];C(p)}catch(r){console.error(r),y.error("فشل تحميل الأدوار")}},c=()=>{if(f){const[r]=t.email?.split("@")||[""],p=t.roles?.[0]?.name||"";P({name:t.name||"",role:p,emailPrefix:r,image:t.image?`${F.baseURL}/${t.image}`:null})}else P({name:"",role:"",emailPrefix:"",image:null});L(null),N({}),b(!1)},g=r=>{const{name:p,value:j}=r.target;P(T=>({...T,[p]:j}))},w=r=>{const p=r.target.files[0];p&&(L(p),P(j=>({...j,image:URL.createObjectURL(p)})))},R=()=>{const r={};return i.name||(r.name=!0),i.role||(r.role=!0),i.emailPrefix||(r.emailPrefix=!0),r},U=async r=>{r.preventDefault();const p=R();if(Object.keys(p).length){N(p);return}b(!0);try{const j=new FormData;j.append("name",i.name),j.append("email",`${i.emailPrefix}@almadar.ly`),j.append("roles[]",i.role),h&&j.append("image",h),f?await x(t.id,j):await o(j),await n(),d()}catch(j){console.error(j),y.error("❌ فشل العملية، تحقق من الحقول أو الدور")}finally{b(!1)}};return s?e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/90 p-6",children:e.jsxs("div",{className:"bg-white dark:bg-gray-900 w-full max-w-lg p-6 rounded-2xl shadow-xl border border-gray-200 dark:border-gray-700 overflow-auto max-h-[90vh]",children:[e.jsx("h2",{className:"text-xl font-bold text-center mb-6 text-gray-800 dark:text-white",children:f?"تعديل المستخدم":"إضافة مستخدم"}),e.jsxs("form",{onSubmit:U,className:"space-y-5 text-sm",children:[e.jsx(xe,{label:"اسم الموظف",icon:e.jsx(V,{className:"ml-2"}),name:"name",value:i.name,onChange:g,error:v.name,disabled:u}),e.jsxs("div",{children:[e.jsx("label",{className:"block mb-1 font-medium text-gray-700 dark:text-gray-300",children:"الدور"}),e.jsxs("select",{name:"role",value:i.role,onChange:g,disabled:u,className:`w-full p-2 rounded border bg-white dark:bg-zinc-800 text-gray-900 dark:text-white ${v.role?"border-red-500":"border-gray-300 dark:border-zinc-600"}`,children:[e.jsx("option",{value:"",children:"اختر الدور"}),k.map(r=>e.jsx("option",{value:r.name,children:ce(r.name)},r.name))]}),v.role&&e.jsx("p",{className:"text-red-600 mt-1 text-xs",children:"يرجى اختيار الدور"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block mb-1 font-medium text-gray-700 dark:text-gray-300",children:"البريد الإلكتروني"}),e.jsxs("div",{className:"flex rounded overflow-hidden border bg-white dark:bg-zinc-800 border-gray-300 dark:border-zinc-600",children:[e.jsx("input",{name:"emailPrefix",value:i.emailPrefix,onChange:g,disabled:u,className:"flex-1 p-2 bg-transparent text-gray-900 dark:text-white"}),e.jsx("span",{className:"p-2 bg-gray-100 dark:bg-zinc-700 text-gray-500 text-xs select-none",children:"@almadar.ly"})]}),v.emailPrefix&&e.jsx("p",{className:"text-red-600 mt-1 text-xs",children:"يرجى إدخال البريد الإلكتروني"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block mb-1 font-medium text-gray-700 dark:text-gray-300",children:"الصورة"}),e.jsx("input",{type:"file",accept:"image/*",disabled:u,onChange:w,className:"w-full text-sm text-gray-700 dark:text-gray-300"}),i.image&&e.jsx("img",{src:i.image,alt:"preview",className:"w-24 h-24 mt-3 object-cover rounded shadow border"})]}),e.jsxs("div",{className:"flex justify-end gap-2 mt-6",children:[e.jsx("button",{type:"button",onClick:d,disabled:u,className:"px-4 py-2 rounded bg-gray-300 hover:bg-gray-400 dark:bg-zinc-700 dark:hover:bg-zinc-600 text-gray-800 dark:text-white",children:"إلغاء"}),e.jsx("button",{type:"submit",disabled:u,className:"px-4 py-2 rounded bg-blue-600 hover:bg-blue-700 text-white shadow",children:u?"...جاري الحفظ":f?"تحديث":"إضافة"})]})]})]})}):null}function xe({label:s,icon:d,name:t,value:n,onChange:o,error:x,disabled:f}){return e.jsxs("div",{children:[e.jsxs("label",{className:"mb-1 flex items-center font-medium text-gray-800 dark:text-gray-200",children:[d," ",s]}),e.jsx("input",{name:t,value:n,onChange:o,disabled:f,className:`w-full p-2 rounded border bg-white dark:bg-zinc-800 text-gray-900 dark:text-white ${x?"border-red-500":"border-gray-300 dark:border-zinc-600"}`}),x&&e.jsx("p",{className:"text-red-600 mt-1 text-xs",children:"هذا الحقل مطلوب"})]})}const ue={admin:"أدمن",staff:"موظف",user:"مستخدم"},ge=({user:s})=>e.jsxs("div",{className:`bg-gradient-primary
    border border-gold/60 dark:border-reded/60 shadow-xl rounded-3xl
    p-6 md:p-8 flex flex-col sm:flex-row items-center gap-6 text-right`,children:[e.jsx("div",{className:"shrink-0",children:e.jsx("div",{className:"w-28 h-28 md:w-36 md:h-36 rounded-full overflow-hidden border-4 border-gold dark:border-reded shadow-lg",children:s.image?e.jsx("img",{src:`${F.baseURL}/${s.image}`,className:"object-cover w-full h-full",alt:"صورة المستخدم"}):e.jsx("div",{className:"bg-muted flex items-center justify-center w-full h-full",children:e.jsx("span",{className:"text-sm text-muted-foreground",children:"بدون صورة"})})})}),e.jsxs("div",{className:"flex-1 space-y-3",children:[e.jsx("h3",{className:"text-xl md:text-2xl font-bold text-primary",children:s.name}),s.role?.name&&e.jsxs("p",{className:"text-success font-semibold",children:["الدور: ",s.role.name]}),s.created_at&&e.jsxs("p",{className:"text-sm text-muted-foreground",children:["تم الإنشاء: ",new Date(s.created_at).toLocaleDateString("ar-EG")]}),e.jsxs("ul",{className:"text-sm text-foreground space-y-2",children:[s.phone&&e.jsxs("li",{className:"flex items-center gap-2 justify-start sm:justify-end",children:[e.jsx(H,{size:16,className:"text-primary-muted"}),e.jsx("span",{children:s.phone})]}),Array.isArray(s.roles)&&s.roles.length>0&&e.jsxs("p",{className:"text-green-700 dark:text-green-400 font-semibold",children:["الدور: ",s.roles.map(d=>ue[d.name]||d.name).join("، ")]}),s.email&&e.jsxs("li",{className:"flex items-center gap-2 justify-start sm:justify-end",children:[e.jsx(G,{size:16,className:"text-success"}),e.jsx("span",{children:s.email})]})]})]})]}),fe=s=>{switch(s){case"view":return"عرض";case"create":return"إضافة";case"update":case"edit":return"تعديل";case"delete":return"حذف";default:return s}},he=s=>({"litigation-from":"دعاوى من الشركة","litigation-against-actions":"إجراءات دعاوى ضد الشركة","litigation-against":"دعاوى ضد الشركة","litigation-from-actions":"إجراءات دعاوى من الشركة",legaladvices:"الرأي والمشورة","managment-lists":"قوائم البيانات",litigations:"القضايا",contracts:"العقود",investigations:"التحقيقات","investigation-actions":"إجراءات التحقيق",users:"المستخدمين",roles:"الأدوار",profile:"الملف الشخصي",permissions:"الصلاحيات"})[s]||s,be=(s=[],d=[])=>{const t=new Set(d.map(n=>n.name.toLowerCase()));return s.reduce((n,o)=>{let[x,...f]=o.name.toLowerCase().split(" ");x==="update"&&(x="edit");const i=f.join(" ");return i&&(n[i]=n[i]||[],n[i].push({id:o.id,name:o.name.toLowerCase(),action:x,enabled:t.has(o.name.toLowerCase())})),n},{})},pe=({label:s,enabled:d,disabled:t,onToggle:n,suppressToast:o})=>e.jsxs("div",{className:"flex items-center justify-between p-2 bg-gray-100 dark:bg-gray-700 rounded mb-2",children:[e.jsx("span",{className:"font-medium",children:s}),e.jsx("button",{className:`text-2xl ${t?"opacity-50":"cursor-pointer"}`,disabled:t,onClick:()=>{if(t){o||y('يجب تفعيل "عرض" أولاً.');return}n(!d)},children:d?e.jsx(_,{className:"text-green-500"}):e.jsx(W,{className:"text-red-500"})})]});function je({allPermissions:s,userPermissions:d,handlePermissionChange:t,loading:n}){const{hasPermission:o}=J(),[x,f]=l.useState({}),i=l.useRef(!1),[P,h]=l.useState(!1),[L,v]=l.useState(!1);l.useEffect(()=>{i.current||(f(be(s,d)),i.current=!0)},[s,d]);const N=(u,b,k={})=>{f(C=>{const S={};for(const[c,g]of Object.entries(C))S[c]=g.map(w=>w.name===u?{...w,enabled:b}:w);return S}),t(u,b,k)};return e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6",children:Object.entries(x).map(([u,b])=>{const k=b.find(c=>c.action==="view"),C=k?.enabled??!1,S=c=>{if(!o("edit permissions")){y.error("ليست لديك صلاحية تعديل الصلاحيات");return}if(N(k.name,c),!c){h(!0),v(!0);let g=!1;b.filter(w=>w.action!=="view"&&w.enabled).forEach(w=>{g=!0,N(w.name,!1,{silent:!0,batch:!0})}),g&&y("تم تعطيل جميع الصلاحيات بسبب إلغاء عرض القسم."),setTimeout(()=>{h(!1),v(!1)},0)}};return e.jsxs("div",{className:"p-4 bg-white dark:bg-gray-800 rounded shadow",children:[e.jsx("h3",{className:"text-center font-bold mb-4",children:he(u)}),["view","create","edit","delete"].map(c=>{const g=b.find(U=>U.action===c);if(!g)return null;const w=n||c!=="view"&&!C,R=c==="view"?S:U=>{if(!o("edit permissions")){y.error("ليست لديك صلاحية تعديل الصلاحيات");return}N(g.name,U)};return e.jsx(pe,{label:fe(c),enabled:g.enabled,disabled:w,onToggle:R,suppressToast:P},g.id)})]},u)})})}function Ce(){const[s,d]=l.useState(null),[t,n]=l.useState(null),[o,x]=l.useState(null),[f,i]=l.useState(!1),[P,h]=l.useState(!1),[L,v]=l.useState(!1),[N,u]=l.useState({name:"",password:"الان12345678"}),b=l.useRef(null),k=l.useRef(null),{data:C=[],isLoading:S,refetch:c}=K(),{data:g=[],isLoading:w}=Q(),{data:R=[]}=Z();l.useEffect(()=>{const a=new IntersectionObserver(([$])=>{$.isIntersecting&&!o&&(d(null),n(null))},{root:null,threshold:.5}),m=k.current;return m&&a.observe(m),()=>{m&&a.unobserve(m)}},[o]);const U=async a=>{h(!0);try{const m=await se(a);y("تم إضافة المستخدم"),u({name:m.name,password:"الان12345678"}),v(!0),await c(),x(null)}catch{y("فشل إضافة المستخدم")}finally{h(!1)}},r=async(a,m)=>{h(!0);try{await te(a,m),y("success","تم تعديل المستخدم"),await c(),x(null)}catch{y("error","فشل تعديل المستخدم")}finally{h(!1)}},p=async(a,m,$={})=>{h(!0);try{await ae(t.id,a,m?"add":"remove"),$?.batch||y("تم تحديث الصلاحية");const[M,...O]=a.toLowerCase().split(" "),B=O.join(" ");let I;M==="view"&&!m?I=t.permissions.filter(A=>!A.name.toLowerCase().includes(B)):t.permissions.findIndex(z=>z.name===a)>-1?I=t.permissions.map(z=>z.name===a?{...z,enabled:m}:z):I=[...t.permissions,{name:a,enabled:m}],n(A=>({...A,permissions:I})),await c()}catch{y("فشل في تحديث الصلاحية")}finally{h(!1)}},j=async()=>{h(!0);try{await re(t.id),y("success","تم حذف المستخدم"),await c(),i(!1),n(null)}catch{y("error","فشل حذف المستخدم")}finally{h(!1)}},T={role:a=>e.jsx("div",{className:"text-center text-sm font-semibold text-green-700 dark:text-green-400",children:a.roles?.[0]?.name||"—"}),image:a=>e.jsx("div",{className:"flex justify-center",children:a.image?e.jsx("img",{src:`${F.baseURL}/${a.image}`,alt:a.name,className:"w-10 h-10 rounded-full object-cover border"}):e.jsx("span",{className:"text-gray-500 text-xs",children:"لا توجد صورة"})}),actions:a=>e.jsxs("div",{className:"flex justify-center gap-2",children:[e.jsx(D.button,{onClick:m=>{m.stopPropagation(),n(a),x("edit")},whileHover:{scale:1.05},whileTap:{scale:.95},className:"p-2 bg-yellow-400 hover:bg-yellow-500 text-white rounded shadow transition",children:e.jsx(q,{className:"w-4 h-4"})}),e.jsx(D.button,{onClick:m=>{m.stopPropagation(),n(a),i(!0)},whileHover:{scale:1.05},whileTap:{scale:.95},className:"p-2 bg-red-500 hover:bg-red-600 text-white rounded shadow transition",children:e.jsx(X,{className:"w-4 h-4"})})]})};return e.jsxs("div",{className:"p-6 sm:p-4 lg:p-6 mt-6",children:[e.jsx(D.div,{initial:{opacity:0,y:-80},animate:{opacity:1,y:0},exit:{opacity:0,y:-40},transition:{type:"spring",stiffness:60,damping:18,delay:.1},children:e.jsx(ne,{icon:oe,listName:"إدارة المستخدمين والصلاحيات"})},"section-header"),e.jsx("div",{className:"bg-white dark:bg-gray-900 rounded-lg shadow border border-gray-200 dark:border-zinc-700",children:e.jsx(D.div,{initial:{opacity:0,y:50},animate:{opacity:1,y:0},exit:{opacity:0,y:-50},transition:{type:"spring",stiffness:60,damping:25},children:e.jsx("div",{ref:k,children:e.jsx(ie,{moduleName:"users",data:C,loading:S,headers:[{key:"id",text:"الرقم"},{key:"name",text:"الاسم"},{key:"email",text:"البريد الإلكتروني"},{key:"role",text:"الدور"},{key:"image",text:"الصورة"},{key:"actions",text:"إجراءات"}],customRenderers:T,renderAddButton:{render:()=>e.jsxs(E,{variant:"default",onClick:()=>{n(null),x("add")},children:["إضافة مستخدم",e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"w-4 h-4 ml-2",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",strokeWidth:2,children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M12 4v16m8-8H4"})})]})},onRowClick:a=>{d(m=>m===a.id?null:a.id),n(a),setTimeout(()=>{b.current&&b.current.scrollIntoView({behavior:"smooth",block:"start"})},300)}})})})}),(o==="add"||o==="edit")&&e.jsx(me,{isOpen:!0,onClose:()=>x(null),selectedUser:o==="edit"?t:null,createUser:U,updateUser:r,roles:g,refreshUsers:c}),e.jsx(ee,{children:t&&s===t.id&&!o&&e.jsxs(D.div,{ref:b,layout:!0,initial:{opacity:0,y:20},animate:{opacity:1,y:0},exit:{opacity:0,y:20},transition:{duration:.3},className:"overflow-hidden mt-6 space-y-6 p-6 bg-white dark:bg-gray-800 rounded-2xl shadow-lg border border-gray-200",children:[e.jsx(ge,{user:t}),e.jsx("h2",{className:"text-xl font-semibold text-center text-green-700 dark:text-green-400 mt-4",children:"صلاحيات المستخدم"}),e.jsx(je,{allPermissions:R,userPermissions:t.permissions,handlePermissionChange:p,loading:P})]},"user-details")}),L&&e.jsx("div",{className:"fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50",children:e.jsxs("div",{className:"bg-white p-6 rounded-lg shadow-lg text-center",children:[e.jsx("h2",{className:"text-xl font-semibold mb-4",children:"تم إضافة المستخدم الجديد"}),e.jsxs("p",{className:"mb-2",children:["اسم المستخدم: ",e.jsx("strong",{children:N.name})]}),e.jsxs("p",{className:"mb-4",children:["كلمة المرور الافتراضية: ",e.jsx("strong",{children:N.password})]}),e.jsx(E,{onClick:()=>v(!1),className:"mt-4",children:"غلق"})]})}),f&&e.jsx(le,{isOpen:f,itemName:t?.name,onConfirm:j,onClose:()=>i(!1)})]})}export{Ce as default};
