import{r as m,j as e,z as A,F as L,D as F,G as R,E as $,H as B,I,J as _,U as S,N as O}from"./pdf-D5yLTPdL.js";import{T as P}from"./TableComponent-oB2Hgwhz.js";import{t as b,ai as G,aj as U,c as H,C as q,m as J,B as V,ak as W}from"./index-BrCJu-Nk.js";import{M as X}from"./ModalCard-BQAsNCRr.js";import Y from"./GlobalConfirmDeleteModal-POJBepxz.js";import"./react-UnWXGYuj.js";import"./vendor-CTvvdsW_.js";const z={id:null,contract_category_id:"",scope:"local",number:"",value:"",contract_parties:"",start_date:"",end_date:"",notes:"",status:"active",summary:"",attachment:null,oldAttachment:null};function K({isOpen:a,onClose:o,initialData:t=null,categories:f=[],reloadContracts:k}){const[n,h]=m.useState(z),[j,x]=m.useState({}),[d,g]=m.useState(!1),[y,N]=m.useState(!1);m.useEffect(()=>{a&&(t?(h({id:t.id||null,contract_category_id:t.contract_category_id||"",scope:t.scope||"local",number:t.number||"",value:t.value!=null?t.value:"",contract_parties:t.contract_parties||"",start_date:t.start_date?t.start_date.slice(0,10):"",end_date:t.end_date?t.end_date.slice(0,10):"",notes:t.notes||"",status:t.status||"active",summary:t.summary||"",attachment:null,oldAttachment:t.attachment||null}),g(!!t.end_date)):(h(z),g(!1)),x({}))},[a,t]);const C=()=>{const s={};return n.contract_category_id||(s.contract_category_id="هذا الحقل مطلوب."),n.number||(s.number="يرجى إدخال رقم العقد."),n.value||(s.value="يرجى إدخال قيمة العقد."),n.contract_parties||(s.contract_parties="يرجى إدخال أطراف العقد."),n.start_date||(s.start_date="يرجى إدخال تاريخ البداية."),n.summary||(s.summary="يرجى كتابة ملخص للعقد."),d&&!n.end_date&&(s.end_date="يرجى إدخال تاريخ الانتهاء."),x(s),Object.keys(s).length===0},l=s=>{const{name:u,value:v,files:M}=s.target;if(u==="attachment"){const p=M[0];if(p&&p.type!=="application/pdf"){b.error("📄 الملف يجب أن يكون بصيغة PDF فقط.");return}h(T=>({...T,attachment:p}))}else h(p=>({...p,[u]:v}));x(p=>({...p,[u]:void 0}))},w=async()=>{if(!C()){b.warning("⚠️ يرجى تعبئة الحقول الإلزامية.");return}N(!0);try{const s=new FormData;Object.entries(n).forEach(([u,v])=>{u==="attachment"&&v instanceof File?s.append("attachment",v):u!=="attachment"&&u!=="oldAttachment"&&v!=null&&s.append(u,v)}),n.id?(s.append("_method","PUT"),await G(n.id,s),b.success("✅ تم تعديل العقد بنجاح")):(await U(s),b.success("✅ تم إضافة العقد بنجاح")),k?.(),o(),h(z)}catch(s){console.error(s),b.error("❌ حدث خطأ أثناء حفظ العقد.")}finally{N(!1)}},r=s=>`w-full p-2 border rounded-lg ${j[s]?"border-red-500 dark:border-red-400 bg-red-50 dark:bg-red-900/30":"border-gray-300 dark:border-zinc-700"}`,i=s=>j[s]?e.jsx("p",{className:"text-xs text-red-600 mt-1",children:j[s]}):null;return e.jsx(X,{isOpen:a,title:t?"تعديل العقد":"إضافة عقد جديد",loading:y,onClose:o,onSubmit:w,submitLabel:t?"تحديث":"إضافة",children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 text-right",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block mb-1 text-sm",children:"التصنيف"}),e.jsxs("select",{name:"contract_category_id",value:n.contract_category_id,onChange:l,className:r("contract_category_id"),required:!0,children:[e.jsx("option",{value:"",children:"اختر تصنيف"}),f.map(s=>e.jsx("option",{value:s.id,children:s.name},s.id))]}),i("contract_category_id")]}),e.jsxs("div",{children:[e.jsx("label",{className:"block mb-1 text-sm",children:"نوع العقد"}),e.jsxs("select",{name:"scope",value:n.scope,onChange:l,className:r("scope"),children:[e.jsx("option",{value:"local",children:"محلي"}),e.jsx("option",{value:"international",children:"دولي"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block mb-1 text-sm",children:"رقم العقد"}),e.jsx("input",{name:"number",value:n.number,onChange:l,className:r("number")}),i("number")]}),e.jsxs("div",{children:[e.jsx("label",{className:"block mb-1 text-sm",children:"قيمة العقد"}),e.jsx("input",{type:"number",name:"value",value:n.value,onChange:l,className:r("value")}),i("value")]}),e.jsxs("div",{className:"md:col-span-2",children:[e.jsx("label",{className:"block mb-1 text-sm",children:"الأطراف المتعاقد معها"}),e.jsx("textarea",{name:"contract_parties",value:n.contract_parties,onChange:l,rows:2,className:r("contract_parties")}),i("contract_parties")]}),e.jsxs("div",{children:[e.jsx("label",{className:"block mb-1 text-sm",children:d?"تاريخ بداية العقد":"تاريخ العقد"}),e.jsx("input",{type:"date",name:"start_date",value:n.start_date,onChange:l,className:r("start_date")}),i("start_date"),d&&e.jsxs("div",{className:"mt-2",children:[e.jsx("label",{className:"block mb-1 text-sm",children:"تاريخ النهاية"}),e.jsx("input",{type:"date",name:"end_date",value:n.end_date,onChange:l,className:r("end_date")}),i("end_date")]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block mb-2 text-sm font-medium",children:"هل للعقد مدة؟"}),e.jsxs("div",{className:"flex gap-4 items-center",children:[e.jsxs("label",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"radio",name:"hasDuration",checked:d,onChange:()=>g(!0)}),e.jsx("span",{children:"نعم"})]}),e.jsxs("label",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"radio",name:"hasDuration",checked:!d,onChange:()=>g(!1)}),e.jsx("span",{children:"لا"})]})]})]}),t&&e.jsxs("div",{className:"md:col-span-2",children:[e.jsx("label",{className:"block mb-1 text-sm",children:"الحالة"}),e.jsxs("select",{name:"status",value:n.status,onChange:l,className:r("status"),children:[e.jsx("option",{value:"active",children:"ساري"}),e.jsx("option",{value:"expired",children:"منتهي"}),e.jsx("option",{value:"terminated",children:"مفسوخ"}),e.jsx("option",{value:"pending",children:"قيد الانتظار"}),e.jsx("option",{value:"cancelled",children:"ملغي"})]})]}),e.jsxs("div",{className:"md:col-span-2",children:[e.jsx("label",{className:"block mb-1 text-sm",children:"ملخص العقد"}),e.jsx("textarea",{name:"summary",value:n.summary,onChange:l,rows:3,className:r("summary")}),i("summary")]}),e.jsxs("div",{className:"md:col-span-2",children:[e.jsx("label",{className:"block mb-1 text-sm",children:"ملاحظات (اختياري)"}),e.jsx("textarea",{name:"notes",value:n.notes,onChange:l,rows:2,className:r("notes")})]}),e.jsxs("div",{className:"md:col-span-2",children:[e.jsx("label",{className:"block mb-1 text-sm",children:"مرفق العقد (PDF فقط)"}),e.jsx("input",{type:"file",name:"attachment",accept:"application/pdf",onChange:l,className:r("attachment")}),n.attachment?e.jsx("p",{className:"mt-1 text-sm text-green-600",children:n.attachment.name}):n.oldAttachment?e.jsx("a",{href:`/storage/${n.oldAttachment}`,target:"_blank",rel:"noopener noreferrer",className:"mt-1 block text-sm text-blue-600 underline",children:"عرض المرفق الحالي"}):null]})]})})}function Q({selected:a,onClose:o}){if(!a)return null;const t=!!a.end_date,f=a.value?`${a.value.toLocaleString()} ريال`:"—";return e.jsxs("div",{className:"relative bg-gradient-to-br from-white to-gray-50 dark:from-zinc-950 dark:to-zinc-900 border border-gray-200 dark:border-zinc-800 rounded-3xl shadow-xl p-6 md:p-10 mt-4 transition-all duration-300 hover:shadow-2xl",children:[e.jsx("button",{onClick:o,className:"absolute top-3 left-3 text-red-500 hover:text-red-700 dark:text-red-400 dark:hover:text-red-300 transition",children:e.jsx(A,{size:22})}),e.jsxs("div",{className:"flex items-center gap-3 mb-6",children:[e.jsx(L,{size:28,className:"text-blue-600 dark:text-blue-400"}),e.jsx("h2",{className:"text-2xl font-bold text-gray-900 dark:text-white",children:"تفاصيل العقد"})]}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 text-sm",children:[e.jsx(c,{icon:e.jsx(F,{}),label:"رقم العقد",value:a.number}),e.jsx(c,{icon:e.jsx(R,{}),label:"نوع العقد",value:a.scope==="local"?"محلي":"دولي"}),e.jsx(c,{icon:e.jsx($,{}),label:"تصنيف العقد",value:a.category?.name}),e.jsx(c,{icon:e.jsx(B,{}),label:"الحالة",value:a.status}),e.jsx(c,{icon:e.jsx(I,{}),label:"قيمة العقد",value:f}),e.jsx(c,{icon:e.jsx(_,{}),label:"تاريخ الإنشاء",value:a.created_at}),e.jsx(c,{icon:e.jsx(_,{}),label:"آخر تحديث",value:a.updated_at}),e.jsx(c,{icon:e.jsx(S,{}),label:"منشئ العقد",value:a.creator?.name}),e.jsx(c,{icon:e.jsx(S,{}),label:"آخر من عدّل العقد",value:a.updater?.name}),e.jsx(c,{icon:e.jsx(_,{}),label:t?"تاريخ بداية العقد":"تاريخ العقد",value:a.start_date}),t&&e.jsx(c,{icon:e.jsx(_,{}),label:"تاريخ نهاية العقد",value:a.end_date}),e.jsxs("div",{className:"col-span-full sm:col-span-2 lg:col-span-1",children:[e.jsxs("span",{className:"flex items-center gap-2 text-gray-600 dark:text-gray-300 font-semibold",children:[e.jsx(F,{size:16}),"المرفق:"]}),a.attachment?e.jsx("a",{href:`${H.baseURL}/storage/${a.attachment}`,target:"_blank",rel:"noopener noreferrer",className:"text-blue-600 dark:text-blue-400 hover:underline ml-1 block mt-1 transition",children:"عرض الملف"}):e.jsx("span",{className:"text-gray-400 dark:text-gray-500 ml-1 mt-1 block",children:"لا يوجد"})]})]}),e.jsx(E,{icon:e.jsx(S,{size:18}),title:"ملخص العقد",children:a.summary||"لا يوجد ملخص متاح."}),e.jsx(E,{icon:e.jsx(O,{size:18}),title:"ملاحظات",children:a.notes||"لا توجد ملاحظات."})]})}function c({icon:a,label:o,value:t}){return e.jsxs("div",{className:"flex items-start gap-3 text-gray-800 dark:text-gray-100",children:[e.jsx("div",{className:"pt-1 text-blue-500 dark:text-blue-300 shrink-0",children:a}),e.jsxs("div",{children:[e.jsx("div",{className:"text-xs text-gray-500 dark:text-gray-400 mb-1",children:o}),e.jsx("div",{className:`font-semibold ${t?"":"text-gray-400 dark:text-zinc-500"}`,children:t||"—"})]})]})}function E({icon:a,title:o,children:t}){return e.jsxs("div",{className:"mt-8 p-6 rounded-2xl bg-gray-100 dark:bg-zinc-800 border border-gray-200 dark:border-zinc-700 shadow-inner",children:[e.jsxs("h3",{className:"text-lg font-semibold text-gray-800 dark:text-white mb-3 flex items-center gap-2",children:[e.jsx("span",{className:"text-blue-500 dark:text-blue-300",children:a}),o]}),e.jsx("p",{className:"text-sm text-gray-700 dark:text-gray-300 leading-relaxed whitespace-pre-line",children:t})]})}function re({contracts:a=[],categories:o=[],reloadContracts:t,scope:f}){const[k,n]=m.useState(null),[h,j]=m.useState(!1),[x,d]=m.useState(null),[g,y]=m.useState(null),N=a.filter(r=>r.scope===f),C=r=>{n(r),j(!0)},l=r=>{d(r)},w=async()=>{if(x)try{await W(x.id),b.success("✅ تم حذف العقد بنجاح"),t?.()}catch{b.error("❌ فشل حذف العقد")}finally{d(null)}};return e.jsxs(e.Fragment,{children:[e.jsx(P,{moduleName:"contracts",data:N,headers:[{key:"number",text:"رقم العقد"},{key:"category_name",text:"التصنيف"},{key:"contract_parties",text:"المتعاقد معه"},{key:"value",text:"القيمة"},{key:"attachment",text:"المرفق"},{key:"status",text:"الحالة"}],customRenderers:{category_name:r=>r.category?.name||"—"},onEdit:C,onDelete:l,renderAddButton:{action:"create",render:()=>e.jsxs(V,{onClick:()=>j(!0),children:["إضافة عقد جديد",e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"w-4 h-4 ml-2",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",strokeWidth:2,children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M12 4v16m8-8H4"})})]})},onRowClick:r=>y(i=>i?.id===r.id?null:r),expandedRowRenderer:r=>g?.id===r.id&&e.jsx("tr",{children:e.jsx("td",{colSpan:6,className:"bg-muted/40",children:e.jsx(q,{mode:"wait",children:e.jsx(J.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},exit:{opacity:0,y:-20},transition:{duration:.4},className:"p-6",children:e.jsx("div",{className:"flex justify-center",children:e.jsx("div",{className:"w-full max-w-3xl",children:e.jsx(Q,{selected:r,onClose:()=>y(null)})})})},r.id)})})})})," ",e.jsx(K,{isOpen:h,onClose:()=>j(!1),initialData:k,categories:o,reloadContracts:t}),e.jsx(Y,{isOpen:!!x,onClose:()=>d(null),onConfirm:w,itemName:x?.number})]})}export{re as default};
