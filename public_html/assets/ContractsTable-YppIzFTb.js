import{j as e}from"./pdf-_01J5l0m.js";import{a as l}from"./react-DxiZ5OBW.js";import{T as M}from"./TableComponent-oKqWs0n5.js";import{t as h,ae as S,af as F,o as T,B as A,ag as B}from"./index-C9wc903-.js";import{M as L}from"./ModalCard-Bqi_hoDA.js";import O from"./GlobalConfirmDeleteModal-DPvq9hXw.js";import"./vendor-CTvvdsW_.js";const C={id:null,contract_category_id:"",scope:"local",number:"",value:"",contract_parties:"",start_date:"",end_date:"",notes:"",status:"active",summary:"",attachment:null,oldAttachment:null};function P({isOpen:b,onClose:f,initialData:s=null,categories:_=[],reloadContracts:g}){const[a,i]=l.useState(C),[j,o]=l.useState({}),[c,d]=l.useState(!1),[y,v]=l.useState(!1);l.useEffect(()=>{b&&(s?(i({id:s.id||null,contract_category_id:s.contract_category_id||"",scope:s.scope||"local",number:s.number||"",value:s.value!=null?s.value:"",contract_parties:s.contract_parties||"",start_date:s.start_date?s.start_date.slice(0,10):"",end_date:s.end_date?s.end_date.slice(0,10):"",notes:s.notes||"",status:s.status||"active",summary:s.summary||"",attachment:null,oldAttachment:s.attachment||null}),d(!!s.end_date)):(i(C),d(!1)),o({}))},[b,s]);const N=()=>{const t={};return a.contract_category_id||(t.contract_category_id="هذا الحقل مطلوب."),a.number||(t.number="يرجى إدخال رقم العقد."),a.value||(t.value="يرجى إدخال قيمة العقد."),a.contract_parties||(t.contract_parties="يرجى إدخال أطراف العقد."),a.start_date||(t.start_date="يرجى إدخال تاريخ البداية."),a.summary||(t.summary="يرجى كتابة ملخص للعقد."),c&&!a.end_date&&(t.end_date="يرجى إدخال تاريخ الانتهاء."),o(t),Object.keys(t).length===0},r=t=>{const{name:m,value:p,files:w}=t.target;if(m==="attachment"){const x=w[0];if(x&&x.type!=="application/pdf"){h.error("📄 الملف يجب أن يكون بصيغة PDF فقط.");return}i(E=>({...E,attachment:x}))}else i(x=>({...x,[m]:p}));o(x=>({...x,[m]:void 0}))},k=async()=>{if(!N()){h.warning("⚠️ يرجى تعبئة الحقول الإلزامية.");return}v(!0);try{const t=new FormData;Object.entries(a).forEach(([m,p])=>{m==="attachment"&&p instanceof File?t.append("attachment",p):m!=="attachment"&&m!=="oldAttachment"&&p!=null&&t.append(m,p)}),a.id?(t.append("_method","PUT"),await S(a.id,t),h.success("✅ تم تعديل العقد بنجاح")):(await F(t),h.success("✅ تم إضافة العقد بنجاح")),g?.(),f(),i(C)}catch(t){console.error(t),h.error("❌ حدث خطأ أثناء حفظ العقد.")}finally{v(!1)}},n=t=>`w-full p-2 border rounded-lg ${j[t]?"border-red-500 dark:border-red-400 bg-red-50 dark:bg-red-900/30":"border-gray-300 dark:border-zinc-700"}`,u=t=>j[t]?e.jsx("p",{className:"text-xs text-red-600 mt-1",children:j[t]}):null;return e.jsx(L,{isOpen:b,title:s?"تعديل العقد":"إضافة عقد جديد",loading:y,onClose:f,onSubmit:k,submitLabel:s?"تحديث":"إضافة",children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 text-right",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block mb-1 text-sm",children:"التصنيف"}),e.jsxs("select",{name:"contract_category_id",value:a.contract_category_id,onChange:r,className:n("contract_category_id"),required:!0,children:[e.jsx("option",{value:"",children:"اختر تصنيف"}),_.map(t=>e.jsx("option",{value:t.id,children:t.name},t.id))]}),u("contract_category_id")]}),e.jsxs("div",{children:[e.jsx("label",{className:"block mb-1 text-sm",children:"نوع العقد"}),e.jsxs("select",{name:"scope",value:a.scope,onChange:r,className:n("scope"),children:[e.jsx("option",{value:"local",children:"محلي"}),e.jsx("option",{value:"international",children:"دولي"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block mb-1 text-sm",children:"رقم العقد"}),e.jsx("input",{name:"number",value:a.number,onChange:r,className:n("number")}),u("number")]}),e.jsxs("div",{children:[e.jsx("label",{className:"block mb-1 text-sm",children:"قيمة العقد"}),e.jsx("input",{type:"number",name:"value",value:a.value,onChange:r,className:n("value")}),u("value")]}),e.jsxs("div",{className:"md:col-span-2",children:[e.jsx("label",{className:"block mb-1 text-sm",children:"الأطراف المتعاقد معها"}),e.jsx("textarea",{name:"contract_parties",value:a.contract_parties,onChange:r,rows:2,className:n("contract_parties")}),u("contract_parties")]}),e.jsxs("div",{children:[e.jsx("label",{className:"block mb-1 text-sm",children:c?"تاريخ بداية العقد":"تاريخ العقد"}),e.jsx("input",{type:"date",name:"start_date",value:a.start_date,onChange:r,className:n("start_date")}),u("start_date"),c&&e.jsxs("div",{className:"mt-2",children:[e.jsx("label",{className:"block mb-1 text-sm",children:"تاريخ النهاية"}),e.jsx("input",{type:"date",name:"end_date",value:a.end_date,onChange:r,className:n("end_date")}),u("end_date")]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block mb-2 text-sm font-medium",children:"هل للعقد مدة؟"}),e.jsxs("div",{className:"flex gap-4 items-center",children:[e.jsxs("label",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"radio",name:"hasDuration",checked:c,onChange:()=>d(!0)}),e.jsx("span",{children:"نعم"})]}),e.jsxs("label",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"radio",name:"hasDuration",checked:!c,onChange:()=>d(!1)}),e.jsx("span",{children:"لا"})]})]})]}),s&&e.jsxs("div",{className:"md:col-span-2",children:[e.jsx("label",{className:"block mb-1 text-sm",children:"الحالة"}),e.jsxs("select",{name:"status",value:a.status,onChange:r,className:n("status"),children:[e.jsx("option",{value:"active",children:"ساري"}),e.jsx("option",{value:"expired",children:"منتهي"}),e.jsx("option",{value:"terminated",children:"مفسوخ"}),e.jsx("option",{value:"pending",children:"قيد الانتظار"}),e.jsx("option",{value:"cancelled",children:"ملغي"})]})]}),e.jsxs("div",{className:"md:col-span-2",children:[e.jsx("label",{className:"block mb-1 text-sm",children:"ملخص العقد"}),e.jsx("textarea",{name:"summary",value:a.summary,onChange:r,rows:3,className:n("summary")}),u("summary")]}),e.jsxs("div",{className:"md:col-span-2",children:[e.jsx("label",{className:"block mb-1 text-sm",children:"ملاحظات (اختياري)"}),e.jsx("textarea",{name:"notes",value:a.notes,onChange:r,rows:2,className:n("notes")})]}),e.jsxs("div",{className:"md:col-span-2",children:[e.jsx("label",{className:"block mb-1 text-sm",children:"مرفق العقد (PDF فقط)"}),e.jsx("input",{type:"file",name:"attachment",accept:"application/pdf",onChange:r,className:n("attachment")}),a.attachment?e.jsx("p",{className:"mt-1 text-sm text-green-600",children:a.attachment.name}):a.oldAttachment?e.jsx("a",{href:`/storage/${a.oldAttachment}`,target:"_blank",rel:"noopener noreferrer",className:"mt-1 block text-sm text-blue-600 underline",children:"عرض المرفق الحالي"}):null]})]})})}function U({contracts:b=[],categories:f=[],reloadContracts:s,scope:_,autoOpen:g=!1}){const[a,i]=l.useState(null),[j,o]=l.useState(!1),[c,d]=l.useState(null),y=T(),v=b.filter(n=>n.scope===_);l.useEffect(()=>{g&&o(!0)},[g]);const N=n=>{i(n),o(!0)},r=n=>{d(n)},k=async()=>{if(c)try{await B(c.id),h.success("✅ تم حذف العقد بنجاح"),s?.()}catch{h.error("❌ فشل حذف العقد")}finally{d(null)}};return e.jsxs(e.Fragment,{children:[e.jsx(M,{moduleName:"contracts",data:v,headers:[{key:"number",text:"رقم العقد"},{key:"category_name",text:"التصنيف"},{key:"contract_parties",text:"المتعاقد معه"},{key:"value",text:"القيمة"},{key:"attachment",text:"المرفق"},{key:"status",text:"الحالة"}],customRenderers:{category_name:n=>n.category?.name||"—"},onEdit:N,onDelete:r,renderAddButton:{action:"create",render:()=>e.jsxs(A,{onClick:()=>o(!0),children:["إضافة عقد جديد",e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"w-4 h-4 ml-2",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",strokeWidth:2,children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M12 4v16m8-8H4"})})]})},onRowClick:n=>y(`/contracts/${n.id}`,{state:n})})," ",e.jsx(P,{isOpen:j,onClose:()=>o(!1),initialData:a,categories:f,reloadContracts:s}),e.jsx(O,{isOpen:!!c,onClose:()=>d(null),onConfirm:k,itemName:c?.number})]})}export{U as default};
